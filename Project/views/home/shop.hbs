<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<section class="shop-section container py-4">
    <div class="row g-3">
        {{#each products}}
            <div class="col-6 col-md-3">
                <div class="product-card">
                    <img src="{{image}}" alt="{{name}}" class="product-img"
                         data-name="{{name}}"
                         data-price="{{price}}"
                         data-img="{{image}}"
                         data-description="{{description}}"
                         data-login="{{#if ../user}}true{{else}}false{{/if}}">
                    <div class="product-info">
                        <p class="product-title">{{name}}</p>
                        <p class="product-price">{{price}}₫</p>
                        <button class="btn-add-cart btn-buy"
                                data-login="{{#if ../user}}true{{else}}false{{/if}}"
                                data-name="{{name}}"
                                data-price="{{price}}"
                                data-img="{{image}}">
                            Buy now
                        </button>
                    </div>
                </div>
            </div>
        {{/each}}
    </div>
</section>

<!-- Modal -->
<div id="productModal" class="modal">
    <span id="modalClose" class="modal-close">&times;</span>
    <div class="modal-content">
        <img id="modalImg" class="modal-img" src="" alt="">
        <div class="modal-info">
            <h5 id="modalName"></h5>

            <div>
                <span class="modal-label">Ý nghĩa:</span>
                <p class="modal-description" id="modalDesc"></p>
            </div>

            <button id="modalBuy" class="btn btn-buy mt-2">Buy now</button>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('productModal');
    const modalImg = document.getElementById('modalImg');
    const modalName = document.getElementById('modalName');
    const modalPrice = document.getElementById('modalPrice');
    const modalDesc = document.getElementById('modalDesc');
    const modalClose = document.getElementById('modalClose');
    const modalBuy = document.getElementById('modalBuy');

    document.querySelectorAll('.product-img').forEach(img=>{
        img.addEventListener('click', ()=>{
            modal.style.display='block';
            modalImg.src = img.dataset.img;
            modalName.innerText = img.dataset.name;

            modalDesc.innerText = img.dataset.description || 'Chưa có mô tả';
            modalBuy.dataset.login = img.dataset.login || 'false';
        });
    });
    modalClose.addEventListener('click', ()=> modal.style.display='none');
    window.addEventListener('click', e=> {if(e.target===modal) modal.style.display='none';});

    modalBuy.addEventListener('click', ()=>{
        if(modalBuy.dataset.login!=='true'){
            alert('Vui lòng đăng nhập để mua hàng!');
            window.location.href='/login';
            return;
        }
        let cart = JSON.parse(localStorage.getItem('cart'))||[];
        const exist = cart.find(i=>i.name===modalName.innerText && i.img===modalImg.src);
        if(exist) exist.qty+=1;
        else cart.push({name:modalName.innerText,img:modalImg.src,price:Number(modalPrice.innerText.replace('₫','')),qty:1});
        localStorage.setItem('cart',JSON.stringify(cart));
        alert('Thêm vào giỏ thành công!');
        modal.style.display='none';
        updateCartIcon();
    });

    document.querySelectorAll('.btn-add-cart').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            if(btn.dataset.login!=='true'){
                alert('Vui lòng đăng nhập để mua hàng!');
                window.location.href='/login';
                return;
            }
            let cart = JSON.parse(localStorage.getItem('cart'))||[];
            const exist = cart.find(i=>i.name===btn.dataset.name && i.img===btn.dataset.img);
            if(exist) exist.qty+=1;
            else cart.push({name:btn.dataset.name,img:btn.dataset.img,price:Number(btn.dataset.price),qty:1});
            localStorage.setItem('cart',JSON.stringify(cart));
            updateCartIcon();
        });
    });

    function updateCartIcon(){
        const cart = JSON.parse(localStorage.getItem('cart'))||[];
        const totalQty = cart.reduce((sum,i)=>sum+i.qty,0);
        const badge = document.getElementById('cart-count');
        if(!badge) return;
        badge.style.display = totalQty>0?'inline-block':'none';
        if(totalQty>0) badge.innerText = totalQty;
    }

    document.addEventListener('DOMContentLoaded', updateCartIcon);
</script>

</body>
</html>
